<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Löwentech AI Asistant</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        #header-container { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        #logo { height: 50px; margin-right: 15px; }
        h1 { color: #4B4B4B; margin: 0; }
        #chat-container { width: 100%; max-width: 800px; height: 100%; overflow-y: auto; border: 1px solid #ddd; border-radius: 12px; padding: 20px; background-color: #ffffff; margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 12px 18px; border-radius: 20px; max-width: 70%; line-height: 1.4; }
        .user { background-color: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .gemini { background-color: #e4e6eb; color: #050505; align-self: flex-start; border-bottom-left-radius: 4px; }
        #controls { text-align: center; position: relative; }
        #start-session-btn { background-color: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 18px; cursor: pointer; transition: opacity 0.5s, visibility 0.5s; }
        #status-indicator { width: 20px; height: 20px; border-radius: 50%; background-color: #6c757d; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); transition: background-color 0.3s; }
        #status-indicator.listening { background-color: #dc3545; }
        #status-indicator.speaking { background-color: #ffc107; }
        #status-text { margin-top: 40px; font-size: 16px; color: #606770; height: 20px; }
    </style>
</head>
<body>

    <div id="header-container">
        <img src="logo.png" alt="Löwentech Logo" id="logo">
        <h1>Löwentech AI Asistant</h1>
    </div>

    <div id="chat-container"></div>
    <div id="controls">
        <button id="start-session-btn">Start</button>
        <div id="status-indicator"></div>
        <div id="status-text"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- API KEYS ---
            const GEMINI_API_KEY = 'AIzaSyB5JHhOBDf0ovescect50h9RDYQcjbSEFM ';
            const GOOGLE_TTS_API_KEY = 'AIzaSyATIItwxr1bU8ACbTbHL69Gh82oPoamlPo';

            // --- ADVANCED SENSITIVITY SETTINGS ---
            const VOICE_THRESHOLD = 0.04;
            const KESINTI_HASSASIYETI = 6; // Turkish name kept for logic consistency
            const SILENCE_TIMEOUT = 1500;
            const API_TIMEOUT = 15000;

            // --- ELEMENTS ---
            const startBtn = document.getElementById('start-session-btn');
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const chatContainer = document.getElementById('chat-container');

            if (!startBtn) {
                console.error("ERROR: Start button not found on the page!");
                return;
            }

            // --- STATE MANAGEMENT ---
            let audioContext, analyser, microphone;
            let isGeminiSpeaking = false;
            let isListeningForSpeech = false;
            let silenceTimer = null;
            let currentAudio = null;
            let interruptionCounter = 0;

            // --- SPEECH-TO-TEXT SETUP ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                // GÜNCELLEME: Hata mesajı İngilizce
                alert("Sorry, your browser does not support the Speech Recognition API. Please use a modern browser like Chrome.");
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.continuous = true;

            // --- START ---
            startBtn.addEventListener('click', () => {
                initAudioProcessing();
                startBtn.style.opacity = '0';
                startBtn.style.visibility = 'hidden';
                // GÜNCELLEME: Durum mesajı İngilizce
                updateStatus('', 'Listening for silence... Please speak.');
            });

            // --- AUDIO PROCESSING & VAD ---
            async function initAudioProcessing() {
                try {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        microphone = audioContext.createMediaStreamSource(stream);
                        analyser = audioContext.createAnalyser();
                        analyser.fftSize = 512;
                        microphone.connect(analyser);
                        detectVoiceActivity();
                    }
                } catch (error) {
                    console.error("Error initializing microphone:", error);
                    // GÜNCELLEME: Hata mesajı İngilizce
                    updateStatus('', "Microphone error! Please check permissions.");
                    alert("Microphone access was denied or an error occurred. Microphone permission is required for the application to work.");
                }
            }

            function detectVoiceActivity() {
                if (!analyser) return;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteTimeDomainData(dataArray);
                let sum = 0;
                for (const value of dataArray) {
                    sum += Math.pow(value / 128.0 - 1.0, 2);
                }
                const volume = Math.sqrt(sum / dataArray.length);

                if (isGeminiSpeaking) {
                    if (volume > VOICE_THRESHOLD) {
                        interruptionCounter = Math.min(interruptionCounter + 2, KESINTI_HASSASIYETI + 1);
                    } else if (interruptionCounter > 0) {
                        interruptionCounter--;
                    }
                    if (interruptionCounter > KESINTI_HASSASIYETI) {
                        handleInterrupt();
                    }
                } else if (volume > VOICE_THRESHOLD && !isListeningForSpeech) {
                    startRecognition();
                }
                requestAnimationFrame(detectVoiceActivity);
            }

            function startRecognition() {
                if (isListeningForSpeech) return;
                try {
                    isListeningForSpeech = true;
                    recognition.start();
                } catch (e) {
                    isListeningForSpeech = false;
                    console.warn("Could not start speech recognition:", e);
                }
            }

            function handleInterrupt() {
                if (!isGeminiSpeaking) return;
                console.log("INTERRUPT!");
                interruptionCounter = 0;
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.onended = null;
                    currentAudio.onerror = null;
                    currentAudio = null;
                }
                isGeminiSpeaking = false;
                if (isListeningForSpeech) {
                    try { recognition.stop(); } catch (e) {}
                }
                setTimeout(startRecognition, 100);
            }

            recognition.onstart = () => {
                isListeningForSpeech = true;
                // GÜNCELLEME: Durum mesajı İngilizce
                updateStatus('listening', "Listening...");
                clearTimeout(silenceTimer);
            };

            recognition.onend = () => {
                isListeningForSpeech = false;
                if (!isGeminiSpeaking) {
                    // GÜNCELLEME: Durum mesajı İngilizce
                    updateStatus('', 'Listening for silence... Please speak.');
                }
            };

            recognition.onresult = (event) => {
                clearTimeout(silenceTimer);
                let fullTranscript = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        fullTranscript += event.results[i][0].transcript;
                    }
                }
                if (fullTranscript.trim()) {
                    try { recognition.stop(); } catch (e) {}
                    processUserCommand(fullTranscript);
                }
                silenceTimer = setTimeout(() => {
                    if (isListeningForSpeech) {
                        try { recognition.stop(); } catch (e) {}
                    }
                }, SILENCE_TIMEOUT);
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                isListeningForSpeech = false;
                if (event.error !== 'aborted') {
                    // GÜNCELLEME: Hata mesajı İngilizce
                    updateStatus('', 'Speech recognition error.');
                }
            };

            function updateStatus(indicatorClass, statusMessage) {
                indicator.className = indicatorClass || '';
                statusText.textContent = statusMessage;
            }

            async function processUserCommand(transcript) {
                addMessageToChat(transcript, 'user');
                // GÜNCELLEME: Durum mesajı İngilizce
                updateStatus('', "Gemini is thinking...");
                try {
                    const geminiResponse = await callGeminiAPI(transcript);
                    addMessageToChat(geminiResponse, 'gemini');
                    await speakWithGoogleTTS(geminiResponse);
                } catch (error) {
                    console.error("Error in processing command:", error);
                    // GÜNCELLEME: Hata mesajı İngilizce
                    const errorMessage = `An error occurred: ${error.message}`;
                    addMessageToChat(errorMessage, 'gemini');
                    resetToListeningState();
                }
            }

            async function speakWithGoogleTTS(text) {
                if (!text || text.trim() === "") {
                    resetToListeningState();
                    return;
                }
                isGeminiSpeaking = true;
                // GÜNCELLEME: Durum mesajı İngilizce
                updateStatus('speaking', "Gemini is speaking...");
                const TTS_API_URL = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_API_KEY}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
                try {
                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input: { text: text },
                            voice: { languageCode: 'tr-TR', name: 'tr-TR-Standard-A' },
                            audioConfig: { audioEncoding: 'MP3' }
                        }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        const errorText = await response.text();
                        // GÜNCELLEME: Hata mesajı İngilizce
                        throw new Error(`Google TTS API error: ${response.status}. Details: ${errorText}`);
                    }
                    const data = await response.json();
                    // GÜNCELLEME: Hata mesajı İngilizce
                    if (!data.audioContent) throw new Error('Audio content not found in TTS response.');
                    const audioBlob = new Blob([Uint8Array.from(atob(data.audioContent), c => c.charCodeAt(0))], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    if (currentAudio) currentAudio.pause();
                    currentAudio = new Audio(audioUrl);
                    await new Promise((resolve, reject) => {
                        currentAudio.onended = () => { if (!currentAudio) return; currentAudio = null; resolve(); };
                        currentAudio.onerror = (e) => { if (!currentAudio) return; currentAudio = null; reject(e); }
                        currentAudio.play().catch(reject);
                    });
                } catch (error) {
                    console.error("TTS Error:", error);
                    // GÜNCELLEME: Hata mesajı İngilizce
                    addMessageToChat(`TTS Error: ${error.name === 'AbortError' ? 'API request timed out' : error.message}`, 'gemini');
                } finally {
                    clearTimeout(timeoutId);
                    if (isGeminiSpeaking) {
                        isGeminiSpeaking = false;
                        resetToListeningState();
                    }
                }
            }

            function resetToListeningState() {
                isGeminiSpeaking = false;
                currentAudio = null;
                // GÜNCELLEME: Durum mesajı İngilizce
                updateStatus('', 'Listening for silence... Please speak.');
            }

            function addMessageToChat(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                messageDiv.textContent = text;
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            async function callGeminiAPI(prompt) {
                if (!GEMINI_API_KEY || GEMINI_API_KEY === 'IHR_GEMINI_API_SCHLUESSEL_HIER') {
                    // GÜNCELLEME: Hata mesajı İngilizce
                    throw new Error("Gemini API key is not set. Please add your key to the GEMINI_API_KEY variable in the code.");
                }
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT);
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: "API response is not valid JSON" } }));
                        console.error("Gemini API Detailed Error:", errorData);
                        throw new Error(errorData.error.message || `API Error ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                         // GÜNCELLEME: Hata mesajı İngilizce
                        return "Received a response from Gemini, but the content is empty. Please try again.";
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error("Error during Gemini API call:", error);
                    if (error.name === 'AbortError') {
                        // GÜNCELLEME: Hata mesajı İngilizce
                        throw new Error("Gemini API request timed out. Please try again.");
                    }
                    throw error;
                }
            }
        });
    </script>

</body>
</html>