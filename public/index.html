<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sesli AI Asistan</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center; color: #333; margin-bottom: 30px; font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .setup-section { background: #f8f9fa; border-radius: 15px; padding: 25px; margin-bottom: 30px; border-left: 4px solid #667eea; }
        .setup-section h3 { color: #333; margin-bottom: 15px; font-size: 1.3em; }
        .api-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        .api-input:focus { outline: none; border-color: #667eea; }
        .save-btn { background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .mic-button {
            width: 100px; height: 100px; border-radius: 50%; border: none; background: linear-gradient(45deg, #667eea, #764ba2);
            color: white; font-size: 24px; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .mic-button:hover { transform: scale(1.1); }
        .mic-button.listening { background: linear-gradient(45deg, #ff6b6b, #ffa500); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .status { text-align: center; margin: 20px 0; padding: 15px; border-radius: 10px; font-weight: 500; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .status.ready { background: #d4edda; color: #155724; }
        .status.listening { background: #fff3cd; color: #856404; }
        .status.processing { background: #cce5ff; color: #004085; }
        .status.error { background: #f8d7da; color: #721c24; }
        .conversation { background: #f8f9fa; border-radius: 15px; padding: 20px; max-height: 400px; overflow-y: auto; margin-bottom: 20px; }
        .message { margin-bottom: 15px; padding: 12px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
        .message.user { background: #667eea; color: white; margin-left: auto; }
        .message.ai { background: #e9ecef; color: #333; }
        .settings { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .setting-group { flex: 1; min-width: 150px; }
        .setting-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .setting-group select, .setting-group input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; }
        .clear-btn { background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 5px; }
        .hidden { display: none; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Sesli AI Asistan</h1>
        <div class="setup-section" id="setup">
            <h3>üîß Backend Kurulumu</h3>
            <p style="margin-bottom: 15px; color: #666;">Vercel API URL'nizi girin:</p>
            <input type="text" id="backendUrl" class="api-input" placeholder="https://your-app.vercel.app/api">
            <button onclick="saveBackendUrl()" class="save-btn">Kaydet</button>
        </div>
        <div class="warning" id="browserWarning">
            ‚ö†Ô∏è Mikrofon eri≈üimi i√ßin bu sayfanƒ±n HTTPS veya localhost √ºzerinden sunulmasƒ± gereklidir.
        </div>
        <div id="mainApp" class="hidden">
            <div class="controls">
                <button id="micButton" class="mic-button" onclick="toggleListening()">üé§</button>
            </div>
            <div id="status" class="status ready">Konu≈ümak i√ßin mikrofon tu≈üuna basƒ±n</div>
            <div class="conversation" id="conversation">
                <div class="message ai">Merhaba! Size nasƒ±l yardƒ±mcƒ± olabilirim?</div>
            </div>
            <div class="settings">
                <div class="setting-group">
                    <label>TTS Modu:</label>
                    <select id="ttsMode">
                        <option value="backend">Backend TTS (Google)</option>
                        <option value="browser">Tarayƒ±cƒ± TTS</option>
                    </select>
                </div>
                <div class="setting-group" id="browserTtsSettings" style="display: none;">
                    <label for="voiceSelect">Tarayƒ±cƒ± Sesi:</label>
                    <select id="voiceSelect"><option value="">Varsayƒ±lan</option></select>
                </div>
                <div>
                    <button onclick="clearConversation()" class="clear-btn">Temizle</button>
                    <button onclick="emergencyStop()" class="clear-btn" style="background: #dc3545;">Durdur</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let recognition;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let isSpeaking = false;
        let backendUrl = '';
        let voices = [];
        let autoMuteTimer = null;
        let currentAudio = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkBrowserSupport();
            loadVoices();
            loadSavedBackendUrl();
            setupEventListeners();
        });

        function checkBrowserSupport() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateStatus('Tarayƒ±cƒ±nƒ±z ses tanƒ±mayƒ± desteklemiyor. Chrome √∂nerilir.', 'error');
                return false;
            }
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.getElementById('browserWarning').style.display = 'block';
            } else {
                document.getElementById('browserWarning').style.display = 'none';
            }
            return true;
        }

        function loadVoices() {
            voices = synthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            const turkishVoices = voices.filter(voice => voice.lang.includes('tr'));
            voiceSelect.innerHTML = '<option value="">Varsayƒ±lan</option>';
            const voicesToDisplay = turkishVoices.length > 0 ? turkishVoices : voices;
            voicesToDisplay.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = voices.indexOf(voice);
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
        }
        if (synthesis.onvoiceschanged !== undefined) {
            synthesis.onvoiceschanged = loadVoices;
        }

        function loadSavedBackendUrl() {
            const saved = localStorage.getItem('backend_url');
            if (saved) {
                backendUrl = saved;
                document.getElementById('backendUrl').value = saved;
                document.getElementById('setup').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                initializeSpeechRecognition();
            }
        }

        function saveBackendUrl() {
            const url = document.getElementById('backendUrl').value.trim();
            if (!url || !url.startsWith('http')) {
                alert('L√ºtfen ge√ßerli bir backend URL girin (http:// veya https:// ile ba≈ülamalƒ±).');
                return;
            }
            backendUrl = url.endsWith('/') ? url.slice(0, -1) : url;
            localStorage.setItem('backend_url', backendUrl);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
            initializeSpeechRecognition();
        }

        function initializeSpeechRecognition() {
            if (!checkBrowserSupport()) return;
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'tr-TR';

            recognition.onstart = () => {
                if (isSpeaking) { recognition.stop(); return; }
                updateStatus('Dinliyorum...', 'listening');
                autoMuteTimer = setTimeout(() => { if (isListening) stopListening('Zaman a≈üƒ±mƒ±'); }, 10000);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (transcript.trim().length < 2) {
                    updateStatus('√áok kƒ±sa, tekrar deneyin', 'error');
                    return;
                }
                addMessage(transcript, 'user');
                processUserInput(transcript);
            };

            recognition.onerror = (event) => { stopListening('Ses tanƒ±ma hatasƒ±: ' + event.error); };
            recognition.onend = () => { if(isListening) stopListening(); };
        }

        function toggleListening() { isListening ? stopListening() : startListening(); }

        function startListening() {
            if (!recognition) { alert('Ses tanƒ±ma hazƒ±r deƒüil.'); return; }
            if (isSpeaking) { updateStatus('AI konu≈üurken dinleme ba≈ülatƒ±lamaz', 'error'); return; }
            emergencyStop(false);
            isListening = true;
            document.getElementById('micButton').classList.add('listening');
            try { recognition.start(); } catch(e) { console.error(e); stopListening('Mikrofon ba≈ülatƒ±lamadƒ±'); }
        }

        function stopListening(statusMessage) {
            isListening = false;
            document.getElementById('micButton').classList.remove('listening');
            if (recognition) try { recognition.stop(); } catch(e) {}
            if (autoMuteTimer) clearTimeout(autoMuteTimer);
            if (!isSpeaking) updateStatus(statusMessage || 'Konu≈ümak i√ßin mikrofon tu≈üuna basƒ±n', 'ready');
        }

        async function processUserInput(text) {
            updateStatus('AI yanƒ±tƒ± hazƒ±rlanƒ±yor...', 'processing');
            try {
                const response = await fetch(`${backendUrl}/ask-gemini`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: text })
                });
                const data = await response.json();
                if (!response.ok) {
                    const errorMessage = data.text || `Backend hatasƒ±: ${response.status}`;
                    addMessage(errorMessage, 'ai');
                    updateStatus(errorMessage, 'error');
                    isSpeaking = false;
                    return;
                }
                addMessage(data.text, 'ai');
                speakText(data.text);
            } catch (error) {
                console.error('Backend ileti≈üim hatasƒ±:', error);
                const errorMessage = `Backend ile ileti≈üim kurulamadƒ±: ${error.message}`;
                addMessage(errorMessage, 'ai');
                updateStatus('Backend hatasƒ±', 'error');
            }
        }

        async function speakText(text) {
            emergencyStop(false); // √ñnceki sesleri durdur
            isSpeaking = true;
            updateStatus('AI yanƒ±tlƒ±yor...', 'processing');

            const ttsMode = document.getElementById('ttsMode').value;
            if (ttsMode === 'backend') {
                try {
                    const response = await fetch(`${backendUrl}/text-to-speech`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    });
                    const data = await response.json();
                    if (!response.ok || data.fallback) {
                        console.warn('Backend TTS hatasƒ±/fallback. Tarayƒ±cƒ± TTS kullanƒ±lƒ±yor.');
                        speakWithBrowserTTS(text);
                        return;
                    }
                    const audioData = `data:audio/mp3;base64,${data.audioContent}`;
                    currentAudio = new Audio(audioData);
                    currentAudio.onended = () => onSpeechEnd();
                    currentAudio.onerror = () => { console.error("Ses √ßalma hatasƒ±."); onSpeechEnd('Ses √ßalma hatasƒ±'); };
                    currentAudio.play();
                } catch (error) {
                    console.error('Backend TTS ileti≈üim hatasƒ±:', error);
                    speakWithBrowserTTS(text);
                }
            } else {
                speakWithBrowserTTS(text);
            }
        }
        
        function speakWithBrowserTTS(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            const voiceIndex = document.getElementById('voiceSelect').value;
            if (voiceIndex) utterance.voice = voices[voiceIndex];
            utterance.lang = 'tr-TR';
            utterance.onend = () => onSpeechEnd();
            utterance.onerror = (e) => { console.error('TTS hatasƒ±:', e); onSpeechEnd('Ses √ßƒ±kƒ±≈ü hatasƒ±'); };
            synthesis.speak(utterance);
        }

        function onSpeechEnd(errorMessage) {
            isSpeaking = false;
            currentAudio = null;
            updateStatus(errorMessage || 'Konu≈ümak i√ßin mikrofon tu≈üuna basƒ±n', errorMessage ? 'error' : 'ready');
        }

        function addMessage(text, sender) {
            const conversation = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = text;
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');

            status.textContent = message;
            status.className = `status ${type}`;
        }

        function clearConversation() {
            document.getElementById('conversation').innerHTML = '<div class="message ai">Konu≈üma temizlendi.</div>';
        }

        function emergencyStop(showStatus = true) {
            synthesis.cancel();
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.onended = null;
                currentAudio.onerror = null;
                currentAudio = null;
            }
            if (recognition && isListening) recognition.abort();
            isSpeaking = false;
            if(showStatus) stopListening('T√ºm i≈ülemler durduruldu.');
        }

        function setupEventListeners() {
            document.getElementById('ttsMode').addEventListener('change', (e) => {
                const browserSettings = document.getElementById('browserTtsSettings');
                browserSettings.style.display = e.target.value === 'browser' ? 'block' : 'none';
            });
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (!isSpeaking) toggleListening();
                }
                if (e.code === 'Escape') emergencyStop();
            });
        }
    </script>
</body>
</html>